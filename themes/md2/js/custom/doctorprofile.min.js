$(function(){var a=$("#btnSubmit"),d=$("#doctor-form"),l=$("#uploader"),k=d.attr("data-url-return"),e=d.attr("data-url-uploadFile"),g=d.attr("data-url-sendEmail");fileParam={},$queue=$('<ul class="filelist"></ul>').appendTo(l.find(".queueList")),$statusBar=l.find(".statusBar"),$info=$statusBar.find(".info"),$upload=a,$placeHolder=l.find(".placeholder"),$progress=$statusBar.find(".progress").hide(),fileCount=0,fileSize=0,ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},supportTransition=(function(){var m=document.createElement("p").style,n="transition" in m||"WebkitTransition" in m||"MozTransition" in m||"msTransition" in m||"OTransition" in m;m=null;return n})(),uploader;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}uploader=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择文件"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,formData:{"doctor[id]":d.find("input#doctorId").val()},server:e,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});uploader.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function b(r){var s=$('<li id="'+r.id+'">'+'<p class="title">'+r.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),p=$('<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span></div>').appendTo(s),o=s.find("p.progress span"),n=s.find("p.imgWrap"),q=$('<p class="error"></p>'),m=function(t){switch(t){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}q.text(text).appendTo(s)};if(r.getStatus()==="invalid"){m(r.statusText)}else{n.text("预览中");uploader.makeThumb(r,function(u,v){if(u){n.text("不能预览");return}var t=$('<img src="'+v+'">');n.empty().append(t)},thumbnailWidth,thumbnailHeight);percentages[r.id]=[r.size,0];r.rotation=0}r.on("statuschange",function(u,t){if(t==="progress"){o.hide().width(0)}else{if(t==="queued"){s.off("mouseenter mouseleave");p.remove()}}if(u==="error"||u==="invalid"){console.log(r.statusText);m(r.statusText);percentages[r.id][1]=1}else{if(u==="interrupt"){m("interrupt")}else{if(u==="queued"){percentages[r.id][1]=0}else{if(u==="progress"){q.remove();o.css("display","block")}else{if(u==="complete"){s.append('<span class="success"></span>')}}}}}s.removeClass("state-"+t).addClass("state-"+u)});s.on("mouseenter",function(){p.stop().animate({height:30})});s.on("mouseleave",function(){p.stop().animate({height:0})});p.on("click","span",function(){var t=$(this).index(),u;switch(t){case 0:uploader.removeFile(r);return;case 1:r.rotation+=90;break;case 2:r.rotation-=90;break}if(supportTransition){u="rotate("+r.rotation+"deg)";n.css({"-webkit-transform":u,"-mos-transform":u,"-o-transform":u,"transform":u})}else{n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((r.rotation/90)%4+4)%4)+")")}});s.appendTo($queue)}function c(m){var n=$("#"+m.id);delete percentages[m.id];j();n.off().find(".file-panel").off().end().remove()}function j(){var m=0,p=0,n=$progress.children(),o;$.each(percentages,function(r,q){p+=q[0];m+=q[0]*q[1]});o=p?m/p:0;n.eq(0).text(Math.round(o*100)+"%");n.eq(1).css("width",Math.round(o*100)+"%");i()}function i(){var n="",m;if(state==="ready"){n="选中"+fileCount+"张图片，共"+WebUploader.formatSize(fileSize)+"。"}else{if(state==="confirm"){m=uploader.getStats();if(m.uploadFailNum){n="已成功上传"+m.successNum+"张图片，"+m.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{m=uploader.getStats();n="共"+fileCount+"张（"+WebUploader.formatSize(fileSize)+"），已上传"+m.successNum+"张";if(m.uploadFailNum){n+="，失败"+m.uploadFailNum+"张"}}}$info.html(n)}function f(o){var n,m;if(o===state){return}$upload.removeClass("state-"+state);$upload.addClass("state-"+o);state=o;switch(state){case"pedding":$placeHolder.removeClass("element-invisible");$queue.parent().removeClass("filled");$queue.hide();$statusBar.addClass("element-invisible");uploader.refresh();break;case"ready":$placeHolder.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");$queue.parent().addClass("filled");$queue.show();$statusBar.removeClass("element-invisible");uploader.refresh();break;case"confirm":$progress.hide();$upload.addClass("disabled");$("#filePicker2").addClass("element-invisible");m=uploader.getStats();if(m.successNum&&!m.uploadFailNum){f("finish");return}break;case"finish":m=uploader.getStats();if(m.successNum){enableBtn(a);h();J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交成功，请耐心等待审核</h4><div class="mt20"><a data-target="link" href="'+k+'" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"})
}else{location.reload()}break}i()}uploader.onUploadProgress=function(o,m){var p=$("#"+o.id),n=p.find(".progress span");n.css("width",m*100+"%");percentages[o.id][1]=m;j()};uploader.onFileQueued=function(m){fileCount++;fileSize+=m.size;if(fileCount===1){$placeHolder.addClass("element-invisible");$statusBar.show()}b(m);f("ready");j()};uploader.onFileDequeued=function(m){fileCount--;fileSize-=m.size;if(!fileCount){f("pedding")}c(m);j()};uploader.on("all",function(n){var m;switch(n){case"uploadFinished":f("confirm");break;case"startUpload":f("uploading");break}});uploader.onError=function(n){var m;switch(n){case"F_DUPLICATE":m="文件名重复!";break;case"F_EXCEED_SIZE":m="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":m="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":m="文件数量过多!";break;case"Q_TYPE_DENIED":m="请选择jpg/jpeg/png或gif格式的图片!";break}J.showToast(m,"",3000)};uploader.on("uploadFinished",function(m,n){});uploader.on("uploadSuccess",function(m,n){});uploader.on("uploadError",function(m,n){console.log(n)});uploader.on("uploadAccept",function(m,n){if(n.status=="no"){enableBtn(a);J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交失败！</h4><p>'+n.error+'</p><div class="mt20"><a data-target="link" href="" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"});return false}});$upload.on("click",function(){disabledBtn(a);if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}if(state==="ready"){uploader.upload()}});$info.on("click",".retry",function(){uploader.retry()});$info.on("click",".ignore",function(){enableBtn(a);location.href=k});$upload.addClass("state-"+state);j();function h(){$.ajax({url:g,type:"post",success:function(){}})}});