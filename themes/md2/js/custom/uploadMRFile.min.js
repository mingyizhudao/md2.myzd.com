$(function(){var t=$(".uploadBtn"),h=$("#patient-form"),o=$("#uploader"),x=h.attr("data-url-return"),n=h.attr("data-url-uploadfile"),w={},i=$('<ul class="filelist"></ul>').appendTo(o.find(".queueList")),u=o.find(".statusBar"),c=u.find(".info"),b=t,g=o.find(".placeholder"),m=u.find(".progress").hide(),y=0,l=0,j=window.devicePixelRatio||1,k=110*j,a=110*j,f="pedding",z={},s=(function(){var A=document.createElement("p").style,B="transition" in A||"WebkitTransition" in A||"MozTransition" in A||"msTransition" in A||"OTransition" in A;A=null;return B})(),q;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}q=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择影像资料"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,formData:{"patient[id]":h.find("input#patientId").val(),"patient[report_type]":"mr"},server:n,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});q.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function r(F){var G=$('<li id="'+F.id+'">'+'<p class="title">'+F.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),D=$('<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span></div>').appendTo(G),C=G.find("p.progress span"),B=G.find("p.imgWrap"),E=$('<p class="error"></p>'),A=function(H){switch(H){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}E.text(text).appendTo(G)};if(F.getStatus()==="invalid"){A(F.statusText)}else{B.text("预览中");q.makeThumb(F,function(I,K){if(I){B.text("不能预览");return}var H=$('<img src="'+K+'">');B.empty().append(H)},k,a);z[F.id]=[F.size,0];F.rotation=0}F.on("statuschange",function(I,H){if(H==="progress"){C.hide().width(0)}else{if(H==="queued"){G.off("mouseenter mouseleave");D.remove()}}if(I==="error"||I==="invalid"){console.log(F.statusText);A(F.statusText);z[F.id][1]=1}else{if(I==="interrupt"){A("interrupt")}else{if(I==="queued"){z[F.id][1]=0}else{if(I==="progress"){E.remove();C.css("display","block")}else{if(I==="complete"){G.append('<span class="success"></span>')}}}}}G.removeClass("state-"+H).addClass("state-"+I)});G.on("mouseenter",function(){D.stop().animate({height:30})});G.on("mouseleave",function(){D.stop().animate({height:0})});D.on("click","span",function(){var H=$(this).index(),I;switch(H){case 0:q.removeFile(F);return;case 1:F.rotation+=90;break;case 2:F.rotation-=90;break}if(s){I="rotate("+F.rotation+"deg)";B.css({"-webkit-transform":I,"-mos-transform":I,"-o-transform":I,"transform":I})}else{B.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((F.rotation/90)%4+4)%4)+")")}});G.appendTo(i)}function v(A){var B=$("#"+A.id);delete z[A.id];d();B.off().find(".file-panel").off().end().remove()}function d(){var A=0,D=0,B=m.children(),C;$.each(z,function(F,E){D+=E[0];A+=E[0]*E[1]});C=D?A/D:0;B.eq(0).text(Math.round(C*100)+"%");B.eq(1).css("width",Math.round(C*100)+"%");e()}function e(){var B="",A;if(f==="ready"){B="选中"+y+"张图片，共"+WebUploader.formatSize(l)+"。"}else{if(f==="confirm"){A=q.getStats();if(A.uploadFailNum){B="已成功上传"+A.successNum+"张图片，"+A.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{A=q.getStats();B="共"+y+"张（"+WebUploader.formatSize(l)+"），已上传"+A.successNum+"张";if(A.uploadFailNum){B+="，失败"+A.uploadFailNum+"张"}}}c.html(B)}function p(C){var B,A;if(C===f){return}b.removeClass("state-"+f);b.addClass("state-"+C);f=C;switch(f){case"pedding":g.removeClass("element-invisible");i.parent().removeClass("filled");i.hide();u.addClass("element-invisible");q.refresh();break;case"ready":g.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");i.parent().addClass("filled");i.show();u.removeClass("element-invisible");q.refresh();break;case"confirm":m.hide();b.addClass("disabled");$("#filePicker2").addClass("element-invisible");A=q.getStats();if(A.successNum&&!A.uploadFailNum){p("finish");return}break;case"finish":A=q.getStats();if(A.successNum){enableBtn(t);location.href=x}else{location.reload()}break}e()}q.onUploadProgress=function(C,A){var D=$("#"+C.id),B=D.find(".progress span");B.css("width",A*100+"%");z[C.id][1]=A;d()};q.onFileQueued=function(A){y++;l+=A.size;if(y===1){g.addClass("element-invisible");u.show()}r(A);p("ready");d()};q.onFileDequeued=function(A){y--;l-=A.size;if(!y){p("pedding")}v(A);d()};q.on("all",function(B){var A;switch(B){case"uploadFinished":p("confirm");break;case"startUpload":p("uploading");break}});q.onError=function(B){var A;switch(B){case"F_DUPLICATE":A="文件名重复!";break;case"F_EXCEED_SIZE":A="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":A="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":A="文件数量过多!";break;case"Q_TYPE_DENIED":A="请选择jpg/jpeg/png或gif格式的图片!";
break}J.showToast(A,"",3000)};q.on("uploadFinished",function(A,B){});q.on("uploadSuccess",function(A,B){});q.on("uploadError",function(A,B){console.log(B)});q.on("uploadAccept",function(A,B){if(B.status=="no"){return false}});b.on("click",function(){disabledBtn(t);if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}if(f==="ready"){q.upload()}});c.on("click",".retry",function(){q.retry()});c.on("click",".ignore",function(){enableBtn(t);location.href=x});b.addClass("state-"+f);d()});