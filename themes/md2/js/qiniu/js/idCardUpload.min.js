$(function(){function setImg(data){function showPreview(e,o){var t=new mOxie.Image;t.onload=function(){t.downsize(300,300),$(o).find("img").attr("src",t.getAsDataURL())},t.load(e.getSource())}var secondImgClick="http://static.mingyizhudao.com/147634523727390",thirdImgClick="http://static.mingyizhudao.com/147634523577826";if(""!=data){var files=data.results.files;if(files&&files.length>0)for(var i=0;i<files.length;i++)1==files[i].certType?firstImgClick=files[i].thumbnailUrl:2==files[i].certType?secondImgClick=files[i].thumbnailUrl:3==files[i].certType&&(thirdImgClick=files[i].thumbnailUrl)}$("#pickfiles2").find("img").attr("src",secondImgClick),$("#pickfiles3").find("img").attr("src",thirdImgClick);var Qiniu2=new QiniuJsSDK,uploader2=Qiniu2.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles2",container:"container2",drop_element:"container2",max_file_size:"100mb",flash_swf_url:"bower_components/plupload/js/Moxie.swf",dragdrop:!0,chunk_size:"4mb",uptoken_url:$("#uptoken_url").val(),domain:$("#domain").val(),get_new_uptoken:!1,multi_selection:!1,auto_start:!1,log_level:5,filters:{prevent_duplicates:!0,mime_types:[{title:"Image files",extensions:"bmp,jpg,gif,png,jpeg"}]},init:{FilesAdded:function(e,o){secondImg=!0,$("table").show(),$("#success").hide(),plupload.each(o,function(o){showPreview(o,"#container2");var t=new FileProgress(o,"fsUploadProgress2");t.setStatus("等待..."),t.bindUploadCancel(e)})},BeforeUpload:function(e,o){var t=new FileProgress(o,"fsUploadProgress2"),i=plupload.parseSize(this.getOption("chunk_size"));"html5"===e.runtime&&i&&t.setChunkProgess(i)},UploadProgress:function(e,o){var t=new FileProgress(o,"fsUploadProgress2"),i=plupload.parseSize(this.getOption("chunk_size"));t.setProgress(o.percent+"%",o.speed,i)},UploadComplete:function(){uploader3.start()},FileUploaded:function(up,file,info){var progress=new FileProgress(file,"fsUploadProgress2"),infoJson=eval("("+info+")");progress.setComplete(up,info);var fileExtension=file.name.substring(file.name.lastIndexOf(".")+1),imgUrl=domForm.find("#domain").val()+"/"+infoJson.key;secondData='"2":{"report_type":"","file_size":"'+encodeURIComponent(file.size)+'","mime_type":"'+encodeURIComponent(file.type)+'","file_name":"'+encodeURIComponent(file.name)+'","file_url":"'+encodeURIComponent(file.name)+'","file_ext":"'+encodeURIComponent(fileExtension)+'","remote_domain":"'+encodeURIComponent(domForm.find("#domain").val())+'","remote_file_key":"'+encodeURIComponent(infoJson.key)+'"},'},Error:function(e,o,t){returnResult=!1,console.log("错误信息"+t),$("table").show();var i=new FileProgress(o.file,"fsUploadProgress2");i.setError(),i.setStatus(t)},Key:function(e,o){var t=o.name.substring(o.name.lastIndexOf(".")+1),i=(new Date).getTime()+""+Math.floor(100*Math.random())+"."+t;return i}}});uploader2.bind("FileUploaded",function(){});var Qiniu3=new QiniuJsSDK,uploader3=Qiniu3.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles3",container:"container3",drop_element:"container3",max_file_size:"100mb",flash_swf_url:"bower_components/plupload/js/Moxie.swf",dragdrop:!0,chunk_size:"4mb",uptoken_url:$("#uptoken_url").val(),domain:$("#domain").val(),get_new_uptoken:!1,multi_selection:!1,auto_start:!1,log_level:5,filters:{prevent_duplicates:!0,mime_types:[{title:"Image files",extensions:"bmp,jpg,gif,png,jpeg"}]},init:{FilesAdded:function(e,o){thirdImg=!0,$("table").show(),$("#success").hide(),plupload.each(o,function(o){showPreview(o,"#container3");var t=new FileProgress(o,"fsUploadProgress3");t.setStatus("等待..."),t.bindUploadCancel(e)})},BeforeUpload:function(e,o){var t=new FileProgress(o,"fsUploadProgress3"),i=plupload.parseSize(this.getOption("chunk_size"));"html5"===e.runtime&&i&&t.setChunkProgess(i)},UploadProgress:function(e,o){var t=new FileProgress(o,"fsUploadProgress3"),i=plupload.parseSize(this.getOption("chunk_size"));t.setProgress(o.percent+"%",o.speed,i)},UploadComplete:function(){var e=firstData+secondData+thirdData;e=e.substr(0,e.length-1);var o='{"auth_file":{'+e+"}}",t=do_encrypt(o,pubkey),i={param:t};$.ajax({url:uploadFile,data:i,type:"post",success:function(e){"ok"==e.status&&(location.href=urlReturn)}})},FileUploaded:function(up,file,info){var progress=new FileProgress(file,"fsUploadProgress3"),infoJson=eval("("+info+")");progress.setComplete(up,info);var fileExtension=file.name.substring(file.name.lastIndexOf(".")+1),imgUrl=domForm.find("#domain").val()+"/"+infoJson.key;thirdData='"3":{"report_type":"","file_size":"'+encodeURIComponent(file.size)+'","mime_type":"'+encodeURIComponent(file.type)+'","file_name":"'+encodeURIComponent(file.name)+'","file_url":"'+encodeURIComponent(file.name)+'","file_ext":"'+encodeURIComponent(fileExtension)+'","remote_domain":"'+encodeURIComponent(domForm.find("#domain").val())+'","remote_file_key":"'+encodeURIComponent(infoJson.key)+'"},'},Error:function(e,o,t){returnResult=!1,console.log("错误信息"+t),$("table").show();var i=new FileProgress(o.file,"fsUploadProgress3");i.setError(),i.setStatus(t)},Key:function(e,o){var t=o.name.substring(o.name.lastIndexOf(".")+1),i=(new Date).getTime()+""+Math.floor(100*Math.random())+"."+t;return i}}});uploader2.bind("FileUploaded",function(){}),submitBtn.click(function(){submitBtn.find("button").attr("disabled",!0),firstImg&&secondImg&&thirdImg?($("#jingle_loading.initLoading").show(),$("#jingle_loading_mask").show(),uploader.start()):($("#jingle_toast").show(),setTimeout(function(){$("#jingle_toast").hide()},1500))}),$("#container").on("dragenter",function(e){e.preventDefault(),$("#container").addClass("draging"),e.stopPropagation()}).on("drop",function(e){e.preventDefault(),$("#container").removeClass("draging"),e.stopPropagation()}).on("dragleave",function(e){e.preventDefault(),$("#container").removeClass("draging"),e.stopPropagation()}).on("dragover",function(e){e.preventDefault(),$("#container").addClass("draging"),e.stopPropagation()}),$("#show_code").on("click",function(){$("#myModal-code").modal(),$("pre code").each(function(e,o){hljs.highlightBlock(o)})}),$("body").on("click","table button.btn",function(){$(this).parents("tr").next().toggle()}),$("#up_load").on("click",function(){uploader.start()});var getRotate=function(e){if(!e)return 0;for(var o=e.split("/"),t=0,i=o.length;i>t;t++)if("rotate"===o[t])return parseInt(o[t+1],10);return 0};$("#myModal-img .modal-body-footer").find("a").on("click",function(){var e=$("#myModal-img").find(".modal-body img"),o=e.data("key"),t=e.attr("src"),i=parseInt(e.data("h"),10),n=[],a=getRotate(t);if($(this).hasClass("no-disable-click")){$(this).siblings().removeClass("disabled");var r=$(this).data("imagemogr");"left"===r?a=0>a-90?a+270:a-90:"right"===r&&(a=a+90>360?a-270:a+90),n.push({fop:"imageMogr2","auto-orient":!0,strip:!0,rotate:a,format:"png"})}else $(this).addClass("disabled").siblings().removeClass("disabled"),"no-rotate"!==$(this).data("imagemogr")&&n.push({fop:"imageMogr2","auto-orient":!0,strip:!0,rotate:a,format:"png"});$("#myModal-img .modal-body-footer").find("a.disabled").each(function(){var e=$(this).data("watermark"),o=$(this).data("imageview"),t=$(this).data("imagemogr");if(e&&n.push({fop:"watermark",mode:1,image:"http://www.b1.qiniudn.com/images/logo-2.png",dissolve:100,gravity:e,dx:100,dy:100}),o){var a;switch(o){case"large":a=i;break;case"middle":a=.5*i;break;case"small":a=.1*i;break;default:a=i}n.push({fop:"imageView2",mode:3,h:parseInt(a,10),q:100,format:"png"})}"no-rotate"===t&&n.push({fop:"imageMogr2","auto-orient":!0,strip:!0,rotate:0,format:"png"})});var s=Qiniu.pipeline(n,o),l=new Image;return e.attr("src","images/loading.gif"),l.onload=function(){e.attr("src",s),e.parent("a").attr("href",s)},l.src=s,!1})}var num=0,domForm=$("#idCard-form"),uploadFile=domForm.attr("data-url-uploadfile"),urlReturn=domForm.attr("data-url-return"),isVerified=$("article").attr("data-isVerified"),submitBtn=$("#submitBtn"),secondData="",thirdData="",secondImg=!1,thirdImg=!1;0!=isVerified&&(secondImg=!0,thirdImg=!0),$.ajax({url:$("article").attr("data-realAuth"),success:function(e){setImg(e)},error:function(e,o,t){setImg(""),console.log(e),console.log(o),console.log(t)}})});